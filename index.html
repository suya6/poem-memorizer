<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¤è¯—èƒŒè¯µåŠ©æ‰‹ğŸ“š</title>
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      padding: 20px;
      background: #fff9f9;
      line-height: 1.6;
    }
    select, textarea, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    #previewArea {
      background: #fff;
      border: 1px dashed #ccc;
      padding: 15px;
      display: none;
      white-space: pre-wrap;
      border-radius: 6px;
    }
    #backgroundPanel {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background: #f0f8ff;
      border-left: 4px solid #4a90e2;
      border-radius: 6px;
    }
    #backgroundPanel h3 {
      margin-top: 0;
      color: #2c3e50;
    }
    #startReciteBtn {
      display: none;
      background: #ff6b6b;
      color: white;
      font-weight: bold;
      padding: 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    #startReciteBtn:hover {
      background: #ff5252;
    }

    /* M4 èƒŒè¯µç•Œé¢ */
    #reciteArea {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #reciteTitle {
      color: #2c3e50;
      margin-top: 0;
    }
    .toggle-btns {
      margin: 10px 0;
    }
    .toggle-btns button {
      padding: 8px 12px;
      margin-right: 8px;
      margin-bottom: 6px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    #prevBtn, #nextBtn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 15px;
    }
    #prevBtn {
      background: #bdc3c7;
      color: #34495e;
    }
    #prevBtn:disabled {
      background: #ecf0f1;
      color: #95a5a6;
      cursor: not-allowed;
    }
    #nextBtn {
      background: #3498db;
      color: white;
      margin-left: 10px;
    }
    #nextBtn:disabled {
      background: #bdc3c7;
      color: #95a5a6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>å¤è¯—èƒŒè¯µåŠ©æ‰‹ğŸ“š</h1>
  <p>é€‰æ‹©æˆ–ç²˜è´´è¦èƒŒè¯µçš„å¤æ–‡</p>

  <label for="poemSelect">é€‰æ‹©ç¯‡ç›®ï¼š</label>
  <select id="poemSelect">
    <option value="">-- è¯·é€‰æ‹© --</option>
    <option value="æ™‹å¤ªå…ƒä¸­ï¼Œæ­¦é™µäººæ•é±¼ä¸ºä¸šï¼Œç¼˜æºªè¡Œï¼Œå¿˜è·¯ä¹‹è¿œè¿‘ã€‚

å¿½é€¢æ¡ƒèŠ±æ—ï¼Œå¤¹å²¸æ•°ç™¾æ­¥ï¼Œä¸­æ— æ‚æ ‘ï¼ŒèŠ³è‰é²œç¾ï¼Œè½è‹±ç¼¤çº·ã€‚

æ¸”äººç”šå¼‚ä¹‹ï¼Œå¤å‰è¡Œï¼Œæ¬²ç©·å…¶æ—ã€‚

æ—å°½æ°´æºï¼Œä¾¿å¾—ä¸€å±±ï¼Œå±±æœ‰å°å£ï¼Œä»¿ä½›è‹¥æœ‰å…‰ã€‚

ä¾¿èˆèˆ¹ï¼Œä»å£å…¥ã€‚åˆæç‹­ï¼Œæ‰é€šäººã€‚å¤è¡Œæ•°åæ­¥ï¼Œè±ç„¶å¼€æœ—ã€‚">ã€Šæ¡ƒèŠ±æºè®°ã€‹</option>
    
    <option value="åº†å†å››å¹´æ˜¥ï¼Œæ»•å­äº¬è°ªå®ˆå·´é™µéƒ¡ã€‚è¶Šæ˜å¹´ï¼Œæ”¿é€šäººå’Œï¼Œç™¾åºŸå…·å…´ã€‚

ä¹ƒé‡ä¿®å²³é˜³æ¥¼ï¼Œå¢å…¶æ—§åˆ¶ï¼Œåˆ»å”è´¤ä»Šäººè¯—èµ‹äºå…¶ä¸Šã€‚

äºˆè§‚å¤«å·´é™µèƒœçŠ¶ï¼Œåœ¨æ´åº­ä¸€æ¹–ã€‚è¡”è¿œå±±ï¼Œåé•¿æ±Ÿï¼Œæµ©æµ©æ±¤æ±¤ï¼Œæ¨ªæ— é™…æ¶¯ã€‚

è‡³è‹¥æ˜¥å’Œæ™¯æ˜ï¼Œæ³¢æ¾œä¸æƒŠï¼Œä¸Šä¸‹å¤©å…‰ï¼Œä¸€ç¢§ä¸‡é¡·ã€‚

å—Ÿå¤«ï¼äºˆå°æ±‚å¤ä»äººä¹‹å¿ƒï¼Œæˆ–å¼‚äºŒè€…ä¹‹ä¸ºï¼Œä½•å“‰ï¼Ÿ">ã€Šå²³é˜³æ¥¼è®°ã€‹ï¼ˆèŠ‚é€‰ï¼‰</option>
    
    <option value="æ°´é™†è‰æœ¨ä¹‹èŠ±ï¼Œå¯çˆ±è€…ç”šè•ƒã€‚æ™‹é™¶æ¸Šæ˜ç‹¬çˆ±èŠã€‚è‡ªæå”æ¥ï¼Œä¸–äººç”šçˆ±ç‰¡ä¸¹ã€‚

äºˆç‹¬çˆ±è²ä¹‹å‡ºæ·¤æ³¥è€Œä¸æŸ“ï¼Œæ¿¯æ¸…æ¶Ÿè€Œä¸å¦–ï¼Œä¸­é€šå¤–ç›´ï¼Œä¸è”“ä¸æã€‚

é¦™è¿œç›Šæ¸…ï¼Œäº­äº­å‡€æ¤ï¼Œå¯è¿œè§‚è€Œä¸å¯äºµç©ç„‰ã€‚

äºˆè°“èŠï¼ŒèŠ±ä¹‹éšé€¸è€…ä¹Ÿï¼›ç‰¡ä¸¹ï¼ŒèŠ±ä¹‹å¯Œè´µè€…ä¹Ÿï¼›è²ï¼ŒèŠ±ä¹‹å›å­è€…ä¹Ÿã€‚">ã€Šçˆ±è²è¯´ã€‹</option>
    
    <option value="å±±ä¸åœ¨é«˜ï¼Œæœ‰ä»™åˆ™åã€‚æ°´ä¸åœ¨æ·±ï¼Œæœ‰é¾™åˆ™çµã€‚

æ–¯æ˜¯é™‹å®¤ï¼ŒæƒŸå¾å¾·é¦¨ã€‚è‹”ç—•ä¸Šé˜¶ç»¿ï¼Œè‰è‰²å…¥å¸˜é’ã€‚

è°ˆç¬‘æœ‰é¸¿å„’ï¼Œå¾€æ¥æ— ç™½ä¸ã€‚å¯ä»¥è°ƒç´ ç´ï¼Œé˜…é‡‘ç»ã€‚

æ— ä¸ç«¹ä¹‹ä¹±è€³ï¼Œæ— æ¡ˆç‰ä¹‹åŠ³å½¢ã€‚å—é˜³è¯¸è‘›åºï¼Œè¥¿èœ€å­äº‘äº­ã€‚">ã€Šé™‹å®¤é“­ã€‹</option>
    
    <option value="ä»å°ä¸˜è¥¿è¡Œç™¾äºŒåæ­¥ï¼Œéš”ç¯ç«¹ï¼Œé—»æ°´å£°ï¼Œå¦‚é¸£ç®ç¯ï¼Œå¿ƒä¹ä¹‹ã€‚

ä¼ç«¹å–é“ï¼Œä¸‹è§å°æ½­ï¼Œæ°´å°¤æ¸…å†½ã€‚å…¨çŸ³ä»¥ä¸ºåº•ï¼Œè¿‘å²¸ï¼Œå·çŸ³åº•ä»¥å‡ºã€‚

æ½­ä¸­é±¼å¯ç™¾è®¸å¤´ï¼Œçš†è‹¥ç©ºæ¸¸æ— æ‰€ä¾ã€‚æ—¥å…‰ä¸‹æ¾ˆï¼Œå½±å¸ƒçŸ³ä¸Šã€‚

åæ½­ä¸Šï¼Œå››é¢ç«¹æ ‘ç¯åˆï¼Œå¯‚å¯¥æ— äººï¼Œå‡„ç¥å¯’éª¨ï¼Œæ‚„æ€†å¹½é‚ƒã€‚">ã€Šå°çŸ³æ½­è®°ã€‹ï¼ˆèŠ‚é€‰ï¼‰</option>
  </select>

  <label for="manualInput">æˆ–ç²˜è´´åŸæ–‡ï¼š</label>
  <textarea id="manualInput" rows="6" placeholder="è¯·åœ¨æ­¤ç²˜è´´å¸¦æ®µè½ç©ºè¡Œçš„å¤æ–‡å…¨æ–‡..."></textarea>

  <div id="previewArea">
    <strong>é¢„è§ˆåŸæ–‡ï¼š</strong>
    <div id="previewText"></div>
  </div>

  <button id="confirmBtn" disabled>âœ… ç¡®è®¤åŸæ–‡</button>

  <!-- M0: åˆ›ä½œèƒŒæ™¯ -->
  <div id="backgroundPanel">
    <h3>ğŸ“œ åˆ›ä½œèƒŒæ™¯</h3>
    <div id="backgroundText"></div>
  </div>

  <!-- å¼€å§‹èƒŒè¯µæŒ‰é’® -->
  <button id="startReciteBtn">ğŸ“– å¼€å§‹èƒŒè¯µ</button>

  <!-- M4: èƒŒè¯µç•Œé¢ -->
  <div id="reciteArea">
    <h2 id="reciteTitle">ğŸ“– ç¬¬ <span id="currentIdx">1</span> / <span id="totalSegs">0</span> æ®µ</h2>
    
    <div class="toggle-btns">
      <button id="toggleImage">ğŸ–¼ï¸ æ˜¾ç¤ºé…å›¾</button>
      <button id="toggleTranslation">ğŸ’¬ æ˜¾ç¤ºè¯‘æ–‡</button>
      <button id="toggleKeyPoints">ğŸ’¡ æ˜¾ç¤ºè€ƒç‚¹</button>
    </div>

    <!-- å†…å®¹å®¹å™¨ï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div id="imageContainer" style="display:none; margin:15px 0;"></div>
    <div id="translationContainer" style="display:none; margin:15px 0;"></div>
    <div id="keyPointsContainer" style="display:none;"></div>
    
    <div>
      <button id="prevBtn" disabled>â¬…ï¸ ä¸Šä¸€æ®µ</button>
      <button id="nextBtn">ä¸‹ä¸€æ®µ â¡ï¸</button>
    </div>
  </div>

  <!-- JS é€»è¾‘ -->
  <script>
    // === å…¨å±€å˜é‡ ===
    window.yuanwen = "";
    window.m3Data = [];
    window.poemMeta = null;
    let currentSegmentIndex = 0;
    const segmentStates = {}; // è®°å½•æ¯æ®µçš„å±•å¼€çŠ¶æ€

    // === M1: é¢„è§ˆ ===
    function updatePreview() {
      const selectVal = document.getElementById('poemSelect').value;
      const manualVal = document.getElementById('manualInput').value.trim();
      const previewArea = document.getElementById('previewArea');
      const previewText = document.getElementById('previewText');
      const confirmBtn = document.getElementById('confirmBtn');

      let textToShow = manualVal || selectVal;

      if (textToShow) {
        previewText.textContent = textToShow;
        previewArea.style.display = 'block';
        confirmBtn.disabled = false;
      } else {
        previewArea.style.display = 'none';
        confirmBtn.disabled = true;
      }
    }

    // === M2: åˆ†æ®µ ===
    function autoSegment(text) {
      if (!text || typeof text !== 'string') return [];
      return text
        .split(/\n\s*\n/)
        .map(p => p.trim())
        .filter(p => p !== '');
    }

    // === M3: å ä½èµ„æºï¼ˆä½¿ç”¨ picsum.photosï¼‰===
    function generatePlaceholderM3Data(segments) {
      return segments.map((_, index) => {
        const i = index + 1;
        return {
          // âœ… ä½¿ç”¨ picsum.photosï¼Œé¿å… via.placeholder.com çš„ DNS é—®é¢˜
          image: `https://picsum.photos/id/${i % 600 + 1}/400/200`,
          translation: `å®å­ï¼ç¬¬${i}æ®µæ¥å•¦ï½ä½ å°±è¯´ï¼šâ€œè¿™é‡Œæ”¾è¶…æœ‰æ¢—çš„ç°ä»£ç¿»è¯‘...â€ ğŸ’¬`,
          keyPoints: `ğŸ’¡è€ƒç‚¹é€Ÿè®°ï¼š\nâ€¢ å­—è¯ï¼šè§£é‡Šï¼ˆå¼€å‘å ä½ï¼Œç¬¬${i}æ®µï¼‰\nâ€¢ å¥å¼ï¼šå¾…å¡«å……`
        };
      });
    }

    // === M0: èƒŒæ™¯å ä½ ===
    function loadPlaceholderMetadata(title) {
      return {
        title: title,
        author: "ä½œè€…å¾…è¡¥å……",
        background: "ã€åˆ›ä½œèƒŒæ™¯å ä½ã€‘\nâ€¢ æ—¶ä»£ï¼šå¾…å¡«å……\nâ€¢ äº‹ä»¶ï¼šå¾…å¡«å……\nâ€¢ æƒ…ç»ªï¼šå¾…å¡«å……\n\nï¼ˆæ™šç‚¹å°†æ›¿æ¢ä¸ºçœŸå®å†å²èƒŒæ™¯ï¼Œå¸®åŠ©ä½ ç†è§£ä½œè€…å¿ƒå¢ƒï¼ï¼‰"
      };
    }

    // === ä¸»æµç¨‹ ===
    function confirmYuanwen() {
      const selectEl = document.getElementById('poemSelect');
      const title = selectEl.options[selectEl.selectedIndex].text;
      const selectVal = selectEl.value;
      const manualVal = document.getElementById('manualInput').value.trim();
      const finalText = manualVal || selectVal;

      if (!finalText) {
        alert("è¯·å…ˆé€‰æ‹©æˆ–è¾“å…¥å¤æ–‡ï¼");
        return;
      }

      window.yuanwen = finalText;
      const segments = autoSegment(finalText);
      window.m3Data = generatePlaceholderM3Data(segments);
      window.poemMeta = loadPlaceholderMetadata(title);

      document.getElementById('backgroundText').textContent = window.poemMeta.background;
      document.getElementById('backgroundPanel').style.display = 'block';
      document.getElementById('startReciteBtn').style.display = 'block';

      console.log("âœ… åŸæ–‡æ€»å­—æ•°:", finalText.length);
      console.log("âœ… åˆ†æ®µæ•°é‡:", segments.length);
      console.log("âœ… M3 æ•°æ®:", window.m3Data);
      console.log("âœ… åˆ›ä½œèƒŒæ™¯:", window.poemMeta);

      alert(`âœ… ${title} å·²åŠ è½½ï¼\nå…± ${segments.length} æ®µ\nåˆ›ä½œèƒŒæ™¯å·²æ˜¾ç¤ºï½`);
    }

    // === M4: èƒŒè¯µç•Œé¢ï¼ˆå½»åº•éšè—å‰ç½®å†…å®¹ï¼‰===
    function renderReciteInterface() {
      if (!window.m3Data || window.m3Data.length === 0) return;

      // âœ… éšè—æ‰€æœ‰ M0-M3 å…ƒç´ 
      document.getElementById('poemSelect').style.display = 'none';
      const manualLabel = document.querySelector('label[for="manualInput"]');
      if (manualLabel) manualLabel.style.display = 'none';
      document.getElementById('manualInput').style.display = 'none';
      document.getElementById('previewArea').style.display = 'none';
      document.getElementById('confirmBtn').style.display = 'none';
      document.getElementById('backgroundPanel').style.display = 'none';
      document.getElementById('startReciteBtn').style.display = 'none';

      // æ˜¾ç¤ºèƒŒè¯µç•Œé¢
      document.getElementById('reciteArea').style.display = 'block';
      updateReciteSegment();
    }

    function updateReciteSegment() {
      const total = window.m3Data.length;
      const idx = currentSegmentIndex;
      const data = window.m3Data[idx];

      if (!segmentStates[idx]) {
        segmentStates[idx] = { image: false, translation: false, keyPoints: false };
      }
      const state = segmentStates[idx];

      document.getElementById('currentIdx').textContent = idx + 1;
      document.getElementById('totalSegs').textContent = total;

      // å¡«å……å†…å®¹
      document.getElementById('imageContainer').innerHTML = 
        `<img src="${data.image}" style="width:100%; max-width:400px; height:auto; border-radius:8px;">`;
      document.getElementById('translationContainer').innerHTML = 
        `<p style="font-size:16px; color:#e74c3c;">${data.translation}</p>`;
      document.getElementById('keyPointsContainer').innerHTML = 
        `<pre style="background:#f9f9f9; padding:12px; border-radius:6px; white-space:pre-wrap;">${data.keyPoints}</pre>`;

      // æ§åˆ¶æ˜¾éš
      document.getElementById('imageContainer').style.display = state.image ? 'block' : 'none';
      document.getElementById('translationContainer').style.display = state.translation ? 'block' : 'none';
      document.getElementById('keyPointsContainer').style.display = state.keyPoints ? 'block' : 'none';

      // æ›´æ–°æŒ‰é’®æ–‡å­—
      document.getElementById('toggleImage').textContent = state.image ? 'ğŸ–¼ï¸ éšè—é…å›¾' : 'ğŸ–¼ï¸ æ˜¾ç¤ºé…å›¾';
      document.getElementById('toggleTranslation').textContent = state.translation ? 'ğŸ’¬ éšè—è¯‘æ–‡' : 'ğŸ’¬ æ˜¾ç¤ºè¯‘æ–‡';
      document.getElementById('toggleKeyPoints').textContent = state.keyPoints ? 'ğŸ’¡ éšè—è€ƒç‚¹' : 'ğŸ’¡ æ˜¾ç¤ºè€ƒç‚¹';

      // å¯¼èˆªæŒ‰é’®çŠ¶æ€
      document.getElementById('prevBtn').disabled = (idx === 0);
      document.getElementById('nextBtn').disabled = (idx === total - 1);
    }

    // === äº‹ä»¶ç»‘å®š ===
    document.getElementById('poemSelect').addEventListener('change', updatePreview);
    document.getElementById('manualInput').addEventListener('input', updatePreview);
    document.getElementById('confirmBtn').addEventListener('click', confirmYuanwen);

    // M4 æ§åˆ¶
    document.getElementById('startReciteBtn').addEventListener('click', function() {
      if (!window.m3Data || window.m3Data.length === 0) {
        alert("è¯·å…ˆç¡®è®¤åŸæ–‡ï¼");
        return;
      }
      currentSegmentIndex = 0;
      renderReciteInterface();
    });

    document.getElementById('prevBtn').addEventListener('click', function() {
      if (currentSegmentIndex > 0) {
        currentSegmentIndex--;
        updateReciteSegment();
      }
    });

    document.getElementById('nextBtn').addEventListener('click', function() {
      if (currentSegmentIndex < window.m3Data.length - 1) {
        currentSegmentIndex++;
        updateReciteSegment();
      }
    });

    // åˆ‡æ¢æ˜¾ç¤º/éšè—
    document.getElementById('toggleImage').addEventListener('click', function() {
      segmentStates[currentSegmentIndex].image = !segmentStates[currentSegmentIndex].image;
      updateReciteSegment();
    });

    document.getElementById('toggleTranslation').addEventListener('click', function() {
      segmentStates[currentSegmentIndex].translation = !segmentStates[currentSegmentIndex].translation;
      updateReciteSegment();
    });

    document.getElementById('toggleKeyPoints').addEventListener('click', function() {
      segmentStates[currentSegmentIndex].keyPoints = !segmentStates[currentSegmentIndex].keyPoints;
      updateReciteSegment();
    });
  </script>
</body>
</html>


